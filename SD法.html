<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>SD法 テキスト刺激版</title>
  <script src="https://unpkg.com/jspsych@7.3.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@1.0.3"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css">
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe"></script>
  <style>
    .stimulus-box {
      border: 2px solid #ccc;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
      background-color: #f9f9f9;
      display: inline-block;
    }
    .stimulus-box p {
      margin: 0;
    }
    .jspsych-survey-likert-opt-label {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      font-size: 25px;
      gap: 6px;
    }
    .jspsych-survey-likert-opt-label input[type="radio"] {
      margin-right: 50px;
      transform: scale(1.5);
    }
    .jspsych-survey-likert-statement {
      margin-bottom: 30px !important;
    }
    .jspsych-survey-likert-opts {
      margin-bottom: 90px !important;
    }
    #jspsych-survey-likert-next {
      display: block;
      margin: 90px auto 90px;
    }
    #jspsych-survey-likert-preamble {
      margin-top: 120px;
      margin-bottom: 50px;
    }
  </style>
</head>
<body></body>

<script>
  const jsPsych = initJsPsych({
    on_finish: function() {
      // SD法 7段階の回答
      const sd7_trials = jsPsych.data.get().filter({ trial_type: 'survey-likert', block: 'SD7' }); // リッカート尺度で評価したデータにフィルタリング
      // 質問 人物像のやつ
      const bio_trials = jsPsych.data.get().filter({ trial_type: 'survey-likert', block: 'BIO' });
      // 刺激ごとの行
      const rows = []; // 数値の格納のための配列

      sd7_trials.values().forEach(trial => {
        const stim = trial.stim || '';  // data から安全に刺激を取る
        const res = trial.response; // データとしてリッカート尺度で入力した数値
        const row = [stim]; // 刺激の配列
        adjectives.forEach((pair, idx) => {
          const index = res[`Q${idx}`]; // リッカート尺度の入力場所indexをとる
          const val = likert_scale[index]; // 評価項目の値を得る
          row.push(val); // 評価値を刺激ごとに格納
        });

        // 追加: 同じ刺激に対応する9段階の結果を取得
        const bio_trial = bio_trials.values().find(t => t.stim === stim);
        if (bio_trial) {
          const bio_index = bio_trial.response['Q0']; // 9段階は1問だからQ0
          const bio_val = likert_bio[bio_index];
          row.push(bio_val);
        } else {
          row.push('');
        }
        
          rows.push(row);
        });


      const demo = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
      const gender = demo?.response?.gender || '';
      const age = demo?.response?.age || '';

      let csv = ['刺激,' + adjectives.map(pair => `${pair.left}-${pair.right}`).join(',') + ',人物像,性別,年齢'].join('\n');
      rows.forEach((r, idx) => {
        if (idx === 0) {
          csv += '\n' + r.join(',') + `,${gender},${age}`;
        } else {
          csv += '\n' + r.join(',') + ',,';
        }
      });
      
      /* BOMをつける
      const BOM = '\uFEFF'
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date();
      const timestamp = now.toISOString().replace(/[:.]/g, '-');
      a.href = url;
      a.download = `data_${timestamp}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    */
    }
  });

  const subject_id = jsPsych.randomization.randomID(10);
  const filename = `${subject_id}.csv`;      

  const intro = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h1>主観評価実験</h1>
      <p>この調査では、アニメの様々な1人称のテキストを見て各設問に評価してもらいます</p>
      <p>前半と後半の2段階のセクションに分かれています</p>
      <p>前半セクションでは、各質問に1から7の7段階評価をしてください</p>
    `,
    choices: ['開始する']
  };

  const stimuli = ["ぼく"];

  const adjectives = [
    { left: "男性的", right: "女性的" },
    { left: "幼い感じ", right: "老けた感じ" },
    { left: "活発な", right: "弱々しい" },
    { left: "親切な", right: "意地悪な" },
    { left: "暖かい", right: "冷たい" },
    { left: "強そう", right: "弱そう" },
    { left: "偉そうな", right: "控えめな" },
  ];

  const likert_scale = ["3", "2", "1", "0", "-1", "-2", "-3"];
  const likert_bio = ["成人男性", "少年", "老人", "上司", "成人女性", "少女", "おばあさん", "お嬢様", "奥様", "幼児"]

  const trials_7 = stimuli.map(stim => {
    const questions = adjectives.map((pair) => ({
      prompt: `<b style="font-size: 24px">${pair.left} - ${pair.right}</b><br>`,
      labels: likert_scale,
      required: true
    }));

    return {
      type: jsPsychSurveyLikert,
      scale_width: 800,
      randomize_question_order: true,
      preamble: `<div class="stimulus-box">
                   <p style="font-size: 50px;">${stim}</p>
                 </div>`,
      questions: questions,
      data: { stim: stim, block: 'SD7' }  // ← ここで安全に刺激情報を保存
    };
  });

  const trials_bio = stimuli.map(stim => ({
    type: jsPsychSurveyLikert,
    scale_width: 1400, 
    preamble: `<div class="stimulus-box">
                 <p style="font-size: 50px;">${stim}</p>
               </div>`,
    questions: [{
      prompt: `<b style="font-size: 24px">表示された単語から連想する人物像を選んでください</b><br>`,
      labels: likert_bio,
      required: true
    }],
    data: { stim: stim, block: 'BIO'},
    block: 'BIO'
  }))

  const intermission = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>つづいて、後半のセクションです</h2>
      <p>後半セクションでは、各質問から連想する人物像を1つ選んで回答してください</p>
      <p>準備ができ次第、下のボタンから先に進んでください</p>`,
    choices: ["進む"]
  };

  const demographics = {
    type: jsPsychSurveyHtmlForm,
    preamble: "<h2>アンケート</h2><p>最後にご自身の以下項目にご回答をお願いします。</p>",
    html: `
      <p>
        性別:
        <label><input name="gender" type="radio" value="male" required> 男性</label>
        <label><input name="gender" type="radio" value="female"> 女性</label>
        <label><input name="gender" type="radio" value="Other"> その他</label>
      </p>
      <p>
        年齢:
        <input name="age" type="number" min="0" max="120" required>
      </p>
    `,
    button_label: "終了"
  };

  let custom_csv = ""; // 仮csv格納変数

  const custom_save = {
    type: jsPsychHtmlButtonResponse,
    stimulus: "保存テスト",
    choices: ["保存する"],
    on_finish: function() {
      console.log("custom_csv:", custom_csv);
      console.log("subject_id:", subject_id);
      console.log("filename:", filename);
    }
  };

 /* const custom_save = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>結果を保存します</h2>
      <p>「保存する」ボタンを押してください。</p>
    `,
    choices: ["保存する"],
    on_finish: function() {

    // === あなたのCSV生成ロジックそのまま ===
    const sd7_trials = jsPsych.data.get().filter({ trial_type: 'survey-likert', block: 'SD7' });
    const bio_trials = jsPsych.data.get().filter({ trial_type: 'survey-likert', block: 'BIO' });
    const rows = [];

    sd7_trials.values().forEach(trial => {
      const stim = trial.stim || '';
      const res = trial.response;
      const row = [stim];
      adjectives.forEach((pair, idx) => {
        const index = res[`Q${idx}`];
        const val = likert_scale[index];
        row.push(val);
      });

      const bio_trial = bio_trials.values().find(t => t.stim === stim);
      if (bio_trial) {
        const bio_index = bio_trial.response['Q0'];
        const bio_val = likert_bio[bio_index];
        row.push(bio_val);
      } else {
        row.push('');
      }

      rows.push(row);
    });

    const demo = jsPsych.data.get().filter({ trial_type: 'survey-html-form' }).values()[0];
    const gender = demo?.response?.gender || '';
    const age = demo?.response?.age || '';

    let csv = ['刺激,' + adjectives.map(pair => `${pair.left}-${pair.right}`).join(',') + ',人物像,性別,年齢'].join('\n');
    rows.forEach((r, idx) => {
      if (idx === 0) {
        csv += '\n' + r.join(',') + `,${gender},${age}`;
      } else {
        csv += '\n' + r.join(',') + ',,';
      }
    });

    // ここでグローバルに代入
    custom_csv = csv;

  }
};*/

  const thanks = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <h2>お疲れ様でした。</h2>
      <p>ご協力ありがとうございました！</p>
      <p>下のボタンを押してからタブを閉じて終了してください。</p>
      <p>デバッグ用</p>`,
    choices: ["終了する"]
  };

  const save_data = {
    type: jsPsychPipe,
    action: "save",
    experiment_id: "nX0ylBPTMR8A",
    filename: filename,
    data_string: ()=>custom_csv
  };

  jsPsych.run([intro, ...trials_7, intermission, ...trials_bio, demographics, custom_save, thanks, save_data]);
</script>
</html>
